<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>Billigaste Kvittot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=3">
</head>
<body>

<header class="site-header">
    <div class="header-content">
        <a href="{{ url_for('index') }}" class="logo-link">
            <img src="{{ url_for('static', filename='assets/bk_logo.png') }}" alt="Billigaste Kvittot Logga" class="site-logo">
        </a>
    </div>
</header>

<div class="container">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <form method="get" id="filter-form" action="/">

            <h3>Butiker</h3>
            {% for s in ["City Gross", "Coop", "Hemköp", "Willys", ] %}
                <label class="checkbox">
                    <input type="checkbox" name="store" value="{{ s }}"
                        {% if s in filters.stores %}checked{% endif %}
                        onchange="this.form.submit()">
                    {{ s }}
                </label>
            {% endfor %}

            <h3>Varumärke</h3>
            <div class="brand-dropdown">
                <input type="text" id="brand-search" placeholder="Sök varumärke..."
                       onfocus="openBrandList()" oninput="filterBrands()">
                <div class="brand-list" id="brand-list">
                    {% for b in brands if b != "Alla" %}
                    <label class="checkbox brand-item">
                        <input type="checkbox" name="brand" value="{{ b }}"
                            {% if b in filters.brands %}checked{% endif %}>
                        {{ b }}
                    </label>
                    {% endfor %}
                </div>
            </div>

            <h3>Sök</h3>
            <input type="text" name="search" value="{{ filters.search }}"
                   placeholder="Tryck Enter för att söka" id="product-search">

            <div class="sidebar-actions">
                <a href="{{ url_for('index') }}" class="btn-secondary">
                    Rensa filter
                </a>
            </div>
        </form>
    </aside>

    <!-- MAIN -->
    <main>
        <div class="result-header">
            Vecka <strong>{{ week }} </strong>Totalt <strong> {{ product_count }}</strong> erbjudanden
        </div>

        <div class="grid">
            {% for p in products %}
            <div class="card">

                <!-- {% if p.promo_text %}
                <div class="promo-tag">{{ p.promo_text }}</div>
                {% endif %} -->

                <div class="image-wrapper">
                    <img src="{{ p.image_url }}" alt="{{ p.product_name }}">
                </div>

                <div class="card-body">
                    <h4>{{ p.product_name }}</h4>
                    <img src="{{ url_for('static', filename='assets/' + p.store_logo) }}" alt="{{ p.store }}" class="store-logo">
                    <p class="meta">{{ p.brand }} - {{p.product_unit}}</p> 

                    <div class="price-row">
                        {% if p.promo_text %}
                            <span class="promo-price">{{ p.promo_text }}</span>
                        {% else %}
                            <span class="promo-price">
                                {{ p.promotion_price_fmt }}
                            </span>
                            <span class="unit">{{ p.unit }}</span>
                        {% endif %}
                    </div>

                    {% if p.ordinary_price_fmt %}
                    <div class="ordinary-price">
                        Ord. pris {{ p.ordinary_price_fmt }} {{ p.unit }}
                    </div>
                    {% endif %}

                    {% if p.max_quantity > 0 %}
                    <div class="limit">
                        Max {{ p.max_quantity }} köp / hushåll               
                    </div>
                    {% endif %}

                    {% if p.end_date %}
                    <span class="badge">
                        Gäller t.o.m {{ p.end_date.strftime('%Y-%m-%d') }}
                    </span>
                    {% endif %}
                </div>

            </div>
            {% endfor %}
        </div>
    </main>

</div>

<script>
let brandListOpen = false;
let brandChanged = false;

function openBrandList() {
    document.getElementById('brand-list').classList.add('open');
    brandListOpen = true;
}

function filterBrands() {
    const search = document.getElementById('brand-search').value.toLowerCase();
    document.getElementById('brand-list').classList.add('open');
    brandListOpen = true;
    document.querySelectorAll('.brand-item').forEach(item => {
        item.style.display = item.textContent.toLowerCase().includes(search) ? '' : 'none';
    });
}

document.querySelectorAll('.brand-item input').forEach(cb => {
    cb.addEventListener('change', () => { brandChanged = true; });
});

document.addEventListener('click', function(e) {
    const dropdown = document.querySelector('.brand-dropdown');
    if (!dropdown.contains(e.target) && brandListOpen) {
        document.getElementById('brand-list').classList.remove('open');
        brandListOpen = false;
        if (brandChanged) {
            document.getElementById('filter-form').submit();
        }
    }
});

document.getElementById('product-search').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('filter-form').submit();
    }
});
</script>
</body>
</html>